---
layout: post
title: 스택 피벗
date: 2025-11-08 19:31:00 +0900
category: pwn
---

- 스택 피벗
    
    `rsp`를 “내가 미리 채워둔 가짜 스택(buffer)”로 옮겨서, 이후의 `ret`들이 그 버퍼에 적어둔 **ROP 체인**을 순서대로 소비하게 만드는 동작.
    

- 피벗이 필요한 이유?
    - **현재 스택에 쓸 수 없다**: 스택에 쓰기 권한이 없거나 용량이 부족함.
    - **체인 크기가 크다**: 커다란 체인을 “다른 안정된 버퍼(예: 전역/힙)”에 두고 싶다.
    - **트리거 제약**: 제어 가능한 건 “한 번의 `ret`”뿐이라서, 그 한 번으로 **`rsp`를 통째로 옮겨** 큰 체인을 실행하고 싶다.


- **강한 피벗**: `xchg rsp, rX` / `mov rsp, rX` / `pop rsp`(존재한다면)
    - 한 번에 `rsp`를 대체 버퍼 시작으로 바꾸는 형태.


- **약한 피벗**: `leave; ret` / `add rsp, imm; ret`
    - 상대적 이동. 충분한 컨트롤이면 큰 피벗도 가능하지만, 일반적으로 **이미 어느 정도 스택을 잡고 있어야** 쓸 만하다.


- 디버깅
    - **피벗 직전**: `RSP`가 어디를 가리키는지, 그 위치의 8바이트들이 무엇인지(=다음 RIP 후보) 확인.
    - **피벗 가젯 실행 직후**: `RSP`가 **내 버퍼 시작**으로 바뀌었는지 확인.
    - **첫 `ret` 이후**: RIP가 내가 의도한 첫 가젯으로 갔는지, `RSP`가 한 슬롯(+8) 전진했는지 확인.
    - **마지막 복귀**: 사용자 공간/커널 상황에 맞는 **복귀 프레임**이 소비되며 정상적으로 돌아오는지 확인.
    
    > 포인트는 “피벗 = RSP 점프”가 정확히 일어났는지와, 이후 ret-사이클이 슬롯 단위로 깨끗하게 진행되는지만 보면 된다.
    >

   